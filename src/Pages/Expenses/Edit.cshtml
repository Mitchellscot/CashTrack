@*@page "{id}"
@model CashTrack.Pages.Expenses.EditModel
@{
    Layout = "_Layout";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center">
        <h3>@(Model.Split > 0 ? "Split" : "Edit") an Expense</h3>
        @if (Model.Split > 0)
        {
            <div class="border rounded px-2 py-1 border-success">
                <h3>Total: <span id="splitTotal">$0.00</span></h3>
            </div>
        }
    </div>
    <hr />
    <form method="post"
          asp-page="./Edit"
          asp-page-handler="SingleExpense"
          id="editSingleExpenseForm">
        <input type="hidden" asp-for="@Model.ExpenseEdit.Id" />
        <div class="row mb-3">
            <div class="col-3">
                <label class="visually-hidden" asp-for="@Model.ExpenseEdit.Date">Date</label>
                <div class="input-group">
                    <div class="input-group-text text-center">Date</div>
                    <input asp-format="{0:yyyy-MM-dd}" data-val="true"
                           asp-for=@Model.ExpenseEdit.Date type="date" class="form-control" id="editExpenseDate">
                    <span asp-validation-for="@Model.ExpenseEdit.Date"></span>
                </div>
            </div>
            <div class="col-3">
                <label class="visually-hidden" asp-for="@Model.ExpenseEdit.Amount">Amount</label>
                <div class="input-group">
                    <div class="input-group-text">$</div>
                    <input data-val="true"
                           asp-for=@Model.ExpenseEdit.Amount type="number" min="0.00" step="any" class="form-control" id="editExpenseAmount" placeholder="0.00">
                    <span asp-validation-for="@Model.ExpenseEdit.Amount"></span>
                </div>
            </div>
            <div class="col-3 align-self-center border rounded py-1 d-flex justify-content-center" style="height: 38px; overflow: hidden;">
                <div class="form-check form-switch">
                    <label class="form-check-label" asp-for="ExpenseEdit.ExcludeFromStatistics">Exclude From Statistics</label>
                    <input class="form-check-input" type="checkbox" role="switch" id="editExpenseExcludeBool" data-val="true"
                           asp-for="ExpenseEdit.ExcludeFromStatistics" />
                    <span asp-validation-for="@Model.ExpenseEdit.ExcludeFromStatistics"></span>
                </div>
            </div>
            <div class="col-3 d-flex justify-content-center">
                <a asp-page="./Edit" asp-route-split="@(Model.Split + 1)" class="btn btn-primary text-wrap" type="button" style="height: 38px;">Split Expense</a>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-8">
                <div class="input-group">
                    <div class="input-group-text">Category</div>
                    <label class="visually-hidden" asp-for="@Model.ExpenseEdit.SubCategoryId">Category</label>
                    <select data-val="true"
                            asp-for=@Model.ExpenseEdit.SubCategoryId
                            asp-items="@Model.SubCategories"
                            class="form-control text-center"
                            id="editExpenseSubCategory">
                    </select>
                    <div class="input-group-text">Main</div>
                    <input value="@Model.InitialMainCategory" disabled type="text" class="form-control text-center bg-white" id="editExpenseMainCategory" required />
                </div>
            </div>
            <div class="col-4 d-flex justify-content-center">
                <a class="btn btn-secondary" type="button" style="height: 38px; overflow: hidden;" asp-page="/SubCategory/add">Add New Category</a>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-8">
                <div class="input-group">
                    <div class="input-group-text">Merchant</div>
                    <label class="visually-hidden" asp-for="MerchantName">Merchant</label>
                    <input class="form-control" data-val="true" type="text" asp-for="MerchantName" id="editExpenseMerchantName" />
                    <span asp-validation-for="@Model.MerchantName"></span>
                </div>
            </div>
            <div class="col-4 align-self-center border rounded py-1">
                <div class="form-check ">
                    <label class="form-check-label" asp-for="CreateNewMerchant">Create New Merchant</label>
                    <input class="form-check-input" type="checkbox" role="switch" id="editExpenseCreateNewMerchant"
                           asp-for="CreateNewMerchant" />
                </div>
            </div>
        </div>
        <div class="row mb-3 px-1">
            <label class="visually-hidden" asp-for="@Model.ExpenseEdit.Notes"></label>
            <textarea class="form-control" asp-for="@Model.ExpenseEdit.Notes" id="editExpenseNotes" rows="3" placeholder="Notes"></textarea>
            <span asp-validation-for="@Model.ExpenseEdit.Notes"></span>
        </div>
    </form>
    @if (Model.Split > 0)
    {
        <hr />
        <div class="row row-cols-4 g-0">
            <form method="post"
              asp-page="./Edit"
              asp-page-handler="MultipleExpenses"
              id="editMultipleExpenseForm">
                @for (int i = 1; i <= Model.Split; i++)
                {
                    <div class="card border-secondary px-0">
                        <div class="card-header text-dark bg-light text-center">
                            <h6 class="card-title">@Model.MerchantName - @Model.ExpenseEdit.Date.Date.ToShortDateString()</h6>
                        </div>
                        <div class="card-body">
                            <input disabled asp-format="{0:yyyy-MM-dd}" data-val="true"
                           asp-for=@Model.BulkExpenses[@i].Date type="date" class="visually-hidden">
                            <input class="visually-hidden" asp-for="MerchantName" />
                            <div class="row">
                                <label class="visually-hidden" asp-for="@Model.ExpenseEdit.Amount">Amount</label>
                                <div class="input-group">
                                    <div class="input-group-text">$</div>
                                    <input data-val="true"
                                   asp-for=@Model.BulkExpenses[@i].Amount
                                   type="number" min="0.00" step="any" class="form-control" id="editExpenseAmount-@i" placeholder="0.00">
                                    <span asp-validation-for="@Model.ExpenseEdit.Amount"></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-group">
                                    <div class="input-group-text">Category</div>
                                    <label class="visually-hidden" asp-for="@Model.ExpenseEdit.SubCategoryId">Category</label>
                                    <select data-val="true"
                                    asp-for=@Model.BulkExpenses[@i].SubCategoryId
                                    asp-items="@Model.SubCategories"
                                    class="form-control text-center"
                                    id="editExpenseSubCategory-@i">
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-group">
                                    <div class="input-group-text pe-4">Main &nbsp; &nbsp; &nbsp;</div>
                                    <input value="@Model.InitialMainCategory"
                                   disabled type="text" class="form-control text-center" id="editExpenseMainCategory-@i" required />
                                </div>

                            </div>
                            <div class="row">
                                <div class="col">
                                    <label class="visually-hidden" asp-for="@Model.BulkExpenses[@i].Notes"></label>
                                    <textarea class="form-control" asp-for="@Model.BulkExpenses[@i].Notes"
                                      id="editExpenseNotes-@i" rows="3" placeholder="Notes"></textarea>
                                    <span asp-validation-for="@Model.ExpenseEdit.Notes"></span>
                                </div>
                            </div>
                            <div class=" card-footer d-flex justify-content-around">
                                <form>
                                    <a asp-page="./Edit" asp-route-split="@(Model.Split-1)" type="button" class="btn btn-outline-danger me-4">Remove</a>
                                </form>
                            </div>
                        </div>
                    </div>
                }
            </form>
        </div>
    }
    <div class="d-flex justify-content-around">
        <a asp-page="./index" class="btn btn-secondary">Cancel</a>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#editDeleteModal">DELETE</button>
        @if (Model.Split == 0)
        {
            <form>
                <button type="submit" class="btn btn-primary" form="editSingleExpenseForm">Save Changes</button>
            </form>
        }
        else
        {
            <form>
                <button type="submit" class="btn btn-primary" form="editMultipleExpenseForm">Save All</button>
            </form>
        }
    </div>

    @*Delete Model*@
    <div class="modal fade" id="editDeleteModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h5 class="modal-title text-center">
                        <strong>Are you sure you want to Delete this Expense?</strong>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true"></span>
                    </button>
                </div>

                <div class="modal-footer d-flex justify-content-evenly">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <form method="post"
                          asp-page="./Index"
                          asp-page-handler="Delete"
                          asp-route-expenseId="@Model.ExpenseEdit.Id"
                          asp-route-pageNumber=1>
                        <button type="submit" class="btn btn-danger">DELETE</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    @*End Delete Modal*@

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-dismissible alert-danger offset-3 w-50 text-center mt-3" asp-validation-summary="All">
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }


</div>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.js" asp-append-version="true"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js" asp-append-version="true"></script>
<partial name="_ValidationScriptsPartial" />
<script type="text/javascript">
    $(document).ready(() => {
        $("form#formID input[type=text]")

        //when adding a new expense amount, make it a nice loking decimal
        $('#editExpenseAmount').change(() => {
                let amount = $("#addExpenseAmount").val();
                let rounded = Math.round(amount * 100) / 100;
                let finalNumber = rounded.toFixed(2);
                $("#addExpenseAmount").val(finalNumber);
        });
        //Autocomplete Merchant Names
         $("#editExpenseMerchantName").on("input", () => {
             let merchantName = $("#editExpenseMerchantName").val();
             $.ajax({
                 url: `/api/merchants/match?merchantName=${merchantName}`,
                 method: 'GET'
             }).then((response) => {
                 console.log(response);
                 $("#editExpenseMerchantName").empty();
                 $("#editExpenseMerchantName").autocomplete({ source: response });
             });
        });
        //loads the main category after sub category is chosen
        $("#editExpenseSubCategory").change(()=>{
            let categoryId = $("#editExpenseSubCategory").val();
            $.ajax({
                url: `/api/maincategory/sub-category/${categoryId}`,
                method: 'GET'
            }).then((response) => {
                    $("#editExpenseMainCategory").prop(`value`, `${response}`);
                }).catch((error) => console.log(error));
        });

        @if(@Model.Split > 0)
        {
            for(int i = 0; i <= Model.Split; i++)
            {
                <text>$("#editExpenseSubCategory-@i").change(()=>{
                    let categoryId = $("#editExpenseSubCategory-@i").val();
                    $.ajax({
                        url: `/api/maincategory/sub-category/${categoryId}`,
                        method: 'GET'
                    }).then((response) => {
                        $("#editExpenseMainCategory-@i").prop(`value`, `${response}`);
                    }).catch((error) => console.log(error));
                });</text>
            }
        }
    });
</script>
    }